---
title: "SIHRD Model"
author: "Linh Tang, Britney He, Bowen Mince"
date: "12/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
```

```{r}
model.data = function(N, beta, I.0, p, epsilon, theta, gamma, TimeH, TimeNH){
  I.rate = beta/N
  psi = 1/TimeH
  lambda = 1/TimeNH
  curr.day = 0
  S = p * N - I.0
  NS.0 = N - S - I.0
  NS = NS.0
  NewInfected = I.0
  Total.Hospital = 0
  Total.NonHospital = 0
  Total.Infected = NewInfected + Total.Hospital + Total.NonHospital
  Total.Infective = NewInfected + Total.NonHospital
  Hospital.Recovered = 0
  NonHospital.Recovered = 0
  Hospital.Dead = 0
  NonHospital.Dead = 0
  Total.Recovered = Hospital.Recovered + NonHospital.Recovered
  Total.Dead = Hospital.Dead + NonHospital.Dead
  Pop = S + NS + Total.Infected + Total.Dead
  Leaving.Hospital = 0
  Leaving.NonHospital = 0
  Recovered.Hospital.today = 0
  Recovered.NonHospital.today = 0
  Entering.Hospital = 0
  
  # If you want a full table like the excel, uncomment all lines in the df below
  df = data_frame(Day = curr.day,
                  Susceptible = S,
                  Non.Susceptible = NS,
                  Daily.New.Case = NewInfected,
                  Total.In.Hospital = Total.Hospital,
                  # Total.NonHospital = Total.NonHospital,
                  Infected = Total.Infected,
                  # Total.Infective = Total.Infective,
                  # Recovered.In.Hospital = Hospital.Recovered,
                  # Dead.In.Hospital = Hospital.Dead,
                  Total.Recovered = Total.Recovered,
                  Total.Dead = Total.Dead)
  
  # Watch the disease until it ends (daily new case = 0) or at max 200 days
  while(NewInfected * S > 0 & curr.day < 200){
    curr.day = curr.day + 1
    
    # Number of individuals recovered from the infected in hospital (previous day)
    Leaving.Hospital = rbinom(1, Total.Hospital, psi)
    Recovered.Hospital.today <- rbinom(1, Leaving.Hospital, theta)
    Hospital.Recovered = Hospital.Recovered + Recovered.Hospital.today
    Hospital.Dead = Hospital.Dead + Leaving.Hospital - Recovered.Hospital.today
    
    # Number of individuals dead from the infected in hospital (previous day)
    NonHospital.leaving = rbinom(1, Total.NonHospital, lambda)
    Recovered.NonHospital.today = rbinom(1, NonHospital.leaving, gamma)
    NonHospital.Recovered = NonHospital.Recovered + Recovered.NonHospital.today
    NonHospital.Dead = NonHospital.Dead + NonHospital.leaving - Recovered.NonHospital.today
    
    # Total number of recovered or dead so far (cumulative)
    Total.Recovered = Hospital.Recovered + NonHospital.Recovered
    Total.Dead = Hospital.Dead + NonHospital.Dead
    
    # Number of individuals hospitalized from the infected in the previous day
    Entering.Hospital = rbinom(1, NewInfected, epsilon)
    Total.Hospital =  Entering.Hospital + Total.Hospital - Leaving.Hospital
    Total.NonHospital = NewInfected + Total.NonHospital - Entering.Hospital - NonHospital.leaving
    
    # Newly infected case today and total actively infected so far
    NewInfected = rbinom(1, S * Total.Infective, I.rate)
    Total.Infected = NewInfected + Total.Hospital + Total.NonHospital
    
    # Susceptible population left
    S = S - NewInfected
    
    # Current non-susceptible group
    NS = NS.0 + Total.Recovered
    
    # Infective group that can spread the disease the next day
    Total.Infective = NewInfected + Total.NonHospital
    
    # Confirm population
    Pop = S + NS + Total.Infected + Total.Dead
    
    # If you want a full table like the excel, uncomment this
    # data = c(curr.day, S, NS, NewInfected, Total.Hospital, Total.NonHospital, Total.Infected, Total.Infective, Hospital.Recovered, Hospital.Dead, Total.Recovered, Total.Dead, Pop)
    data = c(curr.day, S, NS, NewInfected, Total.Hospital, Total.Infected, Total.Recovered, Total.Dead)
    df = rbind(df, data)
  }
  return(df)
}
model.plot = function(data){
  p = ggplot(data  = data, aes(x = Day)) +
        geom_line(aes(y = Susceptible, color = "Susceptible")) +
        geom_line(aes(y = Daily.New.Case, color = "Daily New Case")) +
        geom_line(aes(y = Infected, color = "Infected")) +
        geom_line(aes(y = Total.In.Hospital, color = "Currently In Hospital")) +
        geom_line(aes(y = Total.Recovered, color = "Total Recoverd")) +
        geom_line(aes(y = Total.Dead, color = "Total Dead")) +
        scale_color_discrete(name = "Compartment") +
        labs(y = "Population", title = "SIRHD Model") + 
        theme_minimal()
  return(p)
}
model.info = function(data){
  Last.Day = nrow(data)
  Status = ifelse(data[Last.Day,]$Daily.New.Case == 0, "Ended", "Going")
  Total.Death = data[Last.Day,]$Total.Dead
  Total.Infected = sum(data$Infected)
  Max.New.Case = max(data$Daily.New.Case)
  Peak.Day.New.Case = data[data$Daily.New.Case == Max.New.Case,]$Day
  Max.In.Hospital = max(data$Total.In.Hospital)
  Peak.Day.Hospital= data[data$Total.In.Hospital == Max.In.Hospital,]$Day
  info = c(Last.Day, Status, Total.Death, Total.Infected, Max.New.Case, Peak.Day.New.Case, Max.In.Hospital, Peak.Day.Hospital)
  return(info)
}
# Confirm the model by calculating that all compartments sum to population at any day
model.confirm = function(data){
  data$Pop = data$S + data$NS + data$Total.Infected + data$Total.Dead
  return(data)
}
### UNIT TESTING BY RUNNING EACH OF THESE FUNCTIONS BELOW
# data = model.data(10000, 2, 5, 0.5, 0.8, 0.9, 0.9, 0.1, 0.2)
# model.confirm(data)
# model.plot(data)
# model.info(data)
SIRHD.model = function(N, beta, I.0, p, epsilon, theta, gamma, TimeH, TimeNH){
  param = c(N, beta/N, epsilon, theta, gamma, TimeH, TimeNH)
  data = model.data(N, beta, I.0, p, epsilon, theta, gamma, TimeH, TimeNH)
  plot = model.plot(data)
  result_info = model.info(data)
  info = c(param, result_info)
  return(list(data,plot,info))
}
test.model = SIRHD.model(10000, 2, 5, 0.5, 0.8, 0.9, 0.9, 10, 5)

```

###Factorial Design of 5 factors with 288 levels

\begin{itemize}
    \item Response Variables
    \begin{itemize}
        \item Total Death
        \item Total Infected
        \item Number of Days (disease lasts)
        \item Peak Prevalence (Max Infected Proportion)
        \item Max Hospitalized Proportion
    \end{itemize}
    \item Explanatory Variables
    \begin{itemize}
        \item Population $N$ (3 levels): small town (10,000), big town (100,000), and mega city (1,000,000)
        \item Transmission Rate $\beta$ (2 levels): 2/population and 4/population
        \item Hospitalization Rate $\varepsilon$ (3 levels): 50\%, 60\%, and 70\%
        \item Recovery Rate with Hospitalization $\theta$ (2 levels): 90\% and 95\%
        \item Recovery Rate without Hospitalization $\gamma$ (2 levels): 90\% and 95\%
        \item Average days in hospital $\inv{\psi}$ (2 levels): 10 and 15
        \item Average days in infected status $\inv{\lambda}$ (2 levels): 5 and 10
    \end{itemize}
\end{itemize}

```{r}
I0 = 5
S.rate = 0.5
# List of Explanatory Variables:
Pop.Lst = c(10000, 100000, 1000000)
Beta.Lst = c(2,4)
Hrate.Lst = c(0.5, 0.6, 0.7)
RrateH.Lst = c(0.9, 0.95)
RrateNH.Lst = c(0.9, 0.95)
TimeH.Lst = c(10, 15)
TimeNH.Lst = c(5, 10)
#Pop.Lst, Beta.Lst, Hrate.Lst, RrateH.Lst, RrateNH.Lst, TimeH.Lst, TimeNH.Lst
result_table = data.frame()
for(N in Pop.Lst){
  for(b in Beta.Lst){
    for(hr in Hrate.Lst){
      for(rrh in RrateH.Lst){
        for(rrnh in RrateNH.Lst){
          for(th in TimeH.Lst){
            for(tnh in TimeNH.Lst){
              model = SIRHD.model(N, b, I0, S.rate, hr, rrh, rrnh, th, tnh)
              result_table = rbind(result_table, model[[3]], stringsAsFactors = FALSE)
            }
          }
        }
      }
    }
  }
}
colnames(result_table) = c("Population", "TransmissionRate", "HospitalizationRate", "HospitalizedRecoveryRate", "Non-HospitalizedRecoveryRate", "HospitalizationTime", "InfectionTime", "LastDay", "Status", "TotalDeath", "Total Infected", "Max New Case", "PeakDayNewCase", "MaxInHospital", "PeakDayHospital")
result_table[1:7] = as.data.frame(sapply(result_table[1:7], as.numeric))
result_table[1:7] = format(result_table[1:7], scientific = FALSE)
result_table[c(1:7,9)] = as.data.frame(sapply(result_table[c(1:7,9)], as.factor))
result_table[c(8,10:15)] = as.data.frame(sapply(result_table[c(8,10:15)], as.numeric))
```

###Factorial Design of 5 factors with 288 levels

\begin{itemize}
    \item Response Variables
    \begin{itemize}
        \item Total Death
        \item Total Infected
        \item Number of Days (disease lasts)
        \item Peak Prevalence (Max Infected Proportion)
        \item Max Hospitalized Proportion
    \end{itemize}
    \item Explanatory Variables
    \begin{itemize}
        \item Population $N$ (3 levels): small town (10,000), big town (100,000), and mega city (1,000,000)
        \item Transmission Rate $\beta$ (2 levels): 2/population and 4/population
        \item Hospitalization Rate $\varepsilon$ (3 levels): 50\%, 60\%, and 70\%
        \item Recovery Rate with Hospitalization $\theta$ (2 levels): 90\% and 95\%
        \item Recovery Rate without Hospitalization $\gamma$ (2 levels): 90\% and 95\%
        \item Average days in hospital $\inv{\psi}$ (2 levels): 10 and 15
        \item Average days in infected status $\inv{\lambda}$ (2 levels): 5 and 10
    \end{itemize}
\end{itemize}

```{r}
I0 = 5
S.rate = 0.5
# Parameter:
pops = c(10000, 100000, 1000000)
Beta = c(2,4)
Hrate = c(0.5, 0.6, 0.7)
R.rate.h = c(0.9, 0.95)
R.rate.nh = c(0.9, 0.95)
T.h = c(10, 15)
T.nh = c(5, 10)
for(N in pops){
  for(b in Beta){
    for(hr in Hrate){
      for(rrh in R.rate.h){
        for(rrnh in R.rate.nh){
          for(th in T.h){
            for(tnh in T.nh){
              model = SIRHD.model(N, b, I0, S.rate, hr, rrh, rrhn, th, tnh)
              model.plot(model)
            }
          }
        }
      }
    }
  }
}
`
```