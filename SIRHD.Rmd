---
title: "SIHRD Model"
author: "Linh Tang, Britney He, Bowen Mince"
date: "12/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
```

```{r}
SIRHD.model = function(N, beta, I0, S.rate, H.rate, R.rate.h, R.rate.nh, T.h, T.nh){
  I.rate = beta/N
  D.rate.h = 1 - R.rate.h
  D.rate.nh = 1 - R.rate.nh
  NH.rate = 1 - H.rate
  HospitalOut.rate = 1/T.h
  NonHospitalOut.rate = 1/T.nh
  HospitalIn.rate = 1 - HospitalOut.rate
  NonHospitalIn.rate = 1 - NonHospitalOut.rate
  
  curr.day = 0
  S = S.rate * N - I0
  NS_0 = N - S - I0
  NS = NS_0
  NewInfected = I0
  Tot.Hospital = 0
  Tot.NonHospital = 0
  Tot.Infected = NewInfected + Tot.Hospital + Tot.NonHospital
  Tot.Infective = NewInfected + Tot.NonHospital
  Hospital.Recovered = 0
  NonHospital.Recovered = 0
  Hospital.Dead = 0
  NonHospital.Dead = 0
  Tot.Recovered = Hospital.Recovered + NonHospital.Recovered
  Tot.Dead = Hospital.Dead + NonHospital.Dead
  Pop = S + NS + Tot.Infective + Tot.Dead
  df = data_frame(Day = curr.day,
                  Susceptible = S,
                  Non.Susceptible = NS,
                  Daily.New.Case = NewInfected,
                  Total.In.Hospital = Tot.Hospital,
                  Tot.NonHospital = Tot.NonHospital,
                  Infected = Tot.Infected,
                  Tot.Infective = Tot.Infective,
                  Recovered.In.Hospital = Hospital.Recovered,
                  Dead.In.Hospital = Hospital.Dead,
                  Total.Recovered = Tot.Recovered,
                  Total.Dead = Tot.Dead,
                  Pop = Pop)
  
  # Watch the disease until it ends or at max 200 days
  while(NewInfected * S > 0 & curr.day < 200){
    curr.day = curr.day + 1
    
    # Number of individuals recovered from the infected in hospital (previous day)
    Hospital.Recovered = Hospital.Recovered + round(R.rate.h * round(Tot.Hospital * HospitalOut.rate))
    Hospital.Dead = Hospital.Dead + round(D.rate.h * round(Tot.Hospital * HospitalOut.rate))
    
    # Number of individuals dead from the infected in hospital (previous day)
    NonHospital.Recovered = NonHospital.Recovered + round(R.rate.nh * round(Tot.NonHospital * NonHospitalOut.rate))
    NonHospital.Dead = NonHospital.Dead + round(D.rate.h * round(Tot.NonHospital * NonHospitalOut.rate))
    
    # Total number of recovered or dead so far (cumulative)
    Tot.Recovered = Hospital.Recovered + NonHospital.Recovered
    Tot.Dead = Hospital.Dead + NonHospital.Dead
    
    # Number of individuals hospitalized from the infected in the previous day
    Tot.Hospital = round(NewInfected * H.rate) + round(Tot.Hospital * HospitalIn.rate)
    Tot.NonHospital = round(NewInfected * NH.rate) + round(Tot.NonHospital * NonHospitalIn.rate)
    
    # Newly infected case today and total actively infected so far
    NewInfected = round(I.rate * S * Tot.Infective)
    Tot.Infected = NewInfected + Tot.Hospital + Tot.NonHospital
    
    # Susceptible population left
    S = S - NewInfected
    
    # Current non-susceptible group
    NS = NS_0 + Tot.Recovered
    
    # Infective group that can spread the disease the next day
    Tot.Infective = NewInfected + Tot.NonHospital
    
    # Confirm population
    Pop = S + NS + Tot.Infective + Tot.Dead
    
    data = c(curr.day, S, NS, NewInfected, Tot.Hospital, Tot.NonHospital, Tot.Infected, Tot.Infective, Hospital.Recovered, Hospital.Dead, Tot.Recovered, Tot.Dead, Pop)
    df = rbind(df, data)
  }
  return(df)
}

model.plot = function(model){
  ggplot(data  = model, aes(x = Day)) +
    geom_line(aes(y = Susceptible, color = "Susceptible")) +
    geom_line(aes(y = Daily.New.Case, color = "Daily New Case")) +
    geom_line(aes(y = Infected, color = "Infected")) +
    # geom_line(aes(y = Total.In.Hospital, color = "Currently In Hospital")) +
    # geom_line(aes(y = Recovered.In.Hospital, color = "Total Recovered in Hospital")) +
    # geom_line(aes(y = Dead.In.Hospital, color = "Total Dead in Hospital")) +
    geom_line(aes(y = Total.Recovered, color = "Total Recoverd")) +
    geom_line(aes(y = Total.Dead, color = "Total Dead")) +
    scale_color_discrete(name = "Compartment") +
    labs(y = "Population", title = "SIR Model") + 
    theme_minimal()
}
model = SIRHD.model(10000, 2, 5, 0.5, 0.7, 0.9, 0.9, 10, 5)
# model.plot(model)
```

###Factorial Design of 5 factors with 288 levels

\begin{itemize}
    \item Response Variables
    \begin{itemize}
        \item Total Death
        \item Total Infected
        \item Number of Days (disease lasts)
        \item Peak Prevalence (Max Infected Proportion)
        \item Max Hospitalized Proportion
    \end{itemize}
    \item Explanatory Variables
    \begin{itemize}
        \item Population $N$ (3 levels): small town (10,000), big town (100,000), and mega city (1,000,000)
        \item Transmission Rate $\beta$ (2 levels): 2/population and 4/population
        \item Hospitalization Rate $\varepsilon$ (3 levels): 50\%, 60\%, and 70\%
        \item Recovery Rate with Hospitalization $\theta$ (2 levels): 90\% and 95\%
        \item Recovery Rate without Hospitalization $\gamma$ (2 levels): 90\% and 95\%
        \item Average days in hospital $\inv{\psi}$ (2 levels): 10 and 15
        \item Average days in infected status $\inv{\lambda}$ (2 levels): 5 and 10
    \end{itemize}
\end{itemize}

```{r}
I0 = 5
S.rate = 0.5

# Parameter:
Pops = c(10000, 100000, 1000000)
Beta = c(2,4)
Hrate = c(0.5, 0.6, 0.7)
R.rate.h = c(0.9, 0.95)
R.rate.nh = c(0.9, 0.95)
T.h = c(10, 15)
T.nh = c(5, 10)

for(N in pops){
  for(b in Beta){
    for(hr in Hrate){
      for(rrh in R.rate.h){
        for(rrnh in R.rate.nh){
          for(th in T.h){
            for(tnh in T.nh){
              model = SIRHD.model(N, b, I0, S.rate, hr, rrh, rrhn, th, tnh)
              model.plot(model)
            }
          }
        }
      }
    }
  }
}

```